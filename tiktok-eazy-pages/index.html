<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TikTok Multi-Account Manager — Web</title>
  <style>
    :root{--bg:#0f1720;--card:#0b1115;--accent:#FE2C55;--fg:#e6eef8;--sub:#9CA3AF}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Segoe UI,system-ui,Arial;background:var(--bg);color:var(--fg)}
    .app{display:flex;min-height:100vh}
    .sidebar{width:320px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);padding:24px}
    .brand{font-weight:700;font-size:18px;margin-bottom:18px}
    .btn{display:inline-block;padding:10px 14px;border-radius:10px;background:var(--accent);color:#fff;text-decoration:none;cursor:pointer;border:none}
    .muted{color:var(--sub)}
    .content{flex:1;padding:24px}
    .card{background:var(--card);padding:16px;border-radius:12px;margin-bottom:12px}
    .row{display:flex;gap:12px}
    .col-3{flex:0 0 33%}
    .col-2{flex:0 0 50%}
    input,textarea,select{background:#071018;border:1px solid #12202a;color:var(--fg);padding:8px;border-radius:8px;width:100%}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.02);text-align:left}
    .small{font-size:13px}
    .actions{display:flex;gap:8px}
    .link{color:var(--accent);cursor:pointer;text-decoration:underline}
    footer{color:var(--sub);font-size:13px;margin-top:12px}
    .big-btn{padding:14px 18px;border-radius:14px;background:var(--accent);font-weight:700;border:none;color:#fff}
    .tree{max-height:220px;overflow:auto}
    .notice{background:#11202a;padding:8px;border-radius:8px;color:var(--sub)}
    .flex{display:flex;gap:10px;align-items:center}
    .chip{background:#08131a;padding:6px 8px;border-radius:999px;font-size:13px}
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">TikTok Multi-Account Manager (เว็บ)</div>
      <div style="margin-bottom:10px">
        <div class="chip">แดชบอร์ด</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:10px">
        <button class="btn" onclick="nav('dashboard')">แดชบอร์ด</button>
        <button class="btn" onclick="nav('login')">Login (สแกน/วาง)</button>
        <button class="btn" onclick="nav('composer')">สร้างโพสต์</button>
        <button class="btn" onclick="nav('live')">Live Manager</button>
        <button class="btn" onclick="nav('history')">ประวัติ</button>
        <button class="btn" onclick="nav('manage')">จัดการบัญชี</button>
        <!-- Settings intentionally removed/hidden per request -->
      </div>
      <hr style="margin:14px 0;border-color:rgba(255,255,255,0.02)" />
      <div class="notice small">Local-only: เว็บนี้เก็บข้อมูลใน browser (localStorage). ฟีเจอร์บางอย่างต้อง backend (OAuth แลก token, ffmpeg) — มีคำแนะนำด้านล่าง</div>
      <footer>ไฟล์: index.html — เปิดในเบราว์เซอร์ได้เลย</footer>
    </aside>

    <main class="content">
      <div id="view-area"></div>
    </main>
  </div>

<script>
// --- Minimal client-side app to mimic the Tkinter app behavior ---
const STORAGE_KEY = 'ttm_web_v1'
let state = { accounts:[], posts:[], carts:{}, config: null, products:[] }
function loadState(){
  try{ const raw=localStorage.getItem(STORAGE_KEY); if(raw){ state=JSON.parse(raw) } }
  catch(e){ console.error(e) }
  if(!state.config) state.config = {
    CLIENT_KEY: 'awmb0l4uzmjqs3q0',
    CLIENT_SECRET: '34Wl4GjbyytEotoAzNneBf3blYCZau6g',
    REDIRECT_URI: 'http://localhost:7890/callback',
    OAUTH_SCOPES: 'user.info.basic video.upload video.publish',
    AUTHORIZE_BASE: 'https://open-api.tiktok.com/platform/oauth/connect/',
    TOKEN_ENDPOINT: 'https://open-api.tiktok.com/oauth/access_token/'
  }
  if(!state.products || state.products.length===0) state.products = [
    {id:'P1001',name:'สินค้า A',price:129,link:'https://example.com/P1001'},
    {id:'P1002',name:'สินค้า B',price:249,link:'https://example.com/P1002'},
    {id:'P1003',name:'สินค้า C',price:359,link:'https://example.com/P1003'}
  ]
}
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)) }
loadState()

// --- Navigation ---
function nav(k){ const views = {dashboard:renderDashboard,login:renderLogin,composer:renderComposer,live:renderLive,history:renderHistory,manage:renderManage} 
  const fn = views[k] || renderDashboard; document.getElementById('view-area').innerHTML = ''; fn()
}

// --- Helpers ---
function el(html){ const d=document.createElement('div'); d.innerHTML = html; return d.firstElementChild }
function formatDate(d){ try{ return new Date(d).toLocaleString('th-TH') } catch(e){return d} }
function uid(){ return Math.random().toString(36).slice(2,9) }

// --- Views ---
function renderDashboard(){
  const root = el(`<div>
    <div class="row">
      <div class="col-3 card">
        <h3>สถิติ</h3>
        <div class="small">บัญชีที่เชื่อมแล้ว: <strong id="stat-acc">0</strong></div>
        <div class="small">โพสต์ทั้งหมด: <strong id="stat-posts">0</strong></div>
        <div class="small">คิวโพสต์: <strong id="stat-queue">0</strong></div>
      </div>
      <div class="col-3 card">
        <h3>ด่วน</h3>
        <div style="margin-top:8px"><button class="big-btn" onclick="nav('composer')">สร้างโพสต์</button></div>
      </div>
      <div class="col-3 card">
        <h3>สินค้าแนะนำ</h3>
        <div id="prod-list"></div>
      </div>
    </div>
    <div class="card">
      <h3>บัญชี (คลิกเพื่อเลือก)</h3>
      <div class="tree" id="acc-tree"></div>
    </div>
    <div class="card">
      <h3>โพสต์ล่าสุด</h3>
      <div id="recent-posts"></div>
    </div>
  </div>`)
  document.getElementById('view-area').appendChild(root)
  document.getElementById('stat-acc').innerText = state.accounts.length
  document.getElementById('stat-posts').innerText = state.posts.length
  document.getElementById('stat-queue').innerText = state.posts.filter(p=>p.status==='queued').length

  // accounts
  const at = document.getElementById('acc-tree'); at.innerHTML=''
  state.accounts.forEach(a=>{
    const row = document.createElement('div'); row.style.padding='8px'; row.style.borderBottom='1px solid rgba(255,255,255,0.02)';
    row.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong>${a.label||a.open_id||a.id}</strong><div class="small muted">${a.created_at?formatDate(a.created_at):''}</div></div><div class="actions"><a class='link' onclick='openAccount(${JSON.stringify(a.id)})'>เปิด</a></div></div>`
    at.appendChild(row)
  })

  // products
  const prod = document.getElementById('prod-list'); prod.innerHTML=''
  state.products.forEach(p=>{ const d=document.createElement('div'); d.style.margin='6px 0'; d.innerHTML=`<div style="display:flex;justify-content:space-between"><div>${p.name} <span class='small muted'>฿${p.price}</span></div><div><a class='link' onclick='openLink(${JSON.stringify(p.link)})'>เปิดลิงก์</a> <a class='link' onclick='addProductToCart(${JSON.stringify(p.id)})'>+ตะกร้า</a></div></div>`; prod.appendChild(d) })

  // recent posts
  const rp = document.getElementById('recent-posts'); rp.innerHTML=''
  state.posts.slice().reverse().slice(0,30).forEach(p=>{
    const acc = state.accounts.find(a=>a.id===p.account_id) || {label:p.account_id}
    const div = document.createElement('div'); div.style.padding='6px'; div.innerHTML = `<div><strong>${acc.label||acc.id}</strong> — ${p.caption? (p.caption.length>80? p.caption.slice(0,80)+'...':p.caption) : '(no caption)'} <div class='small muted'>${formatDate(p.created_at)} • ${p.status}</div></div>`
    rp.appendChild(div)
  })
}

function renderLogin(){
  const root = el(`<div class="card">
    <h3>เชื่อมบัญชี TikTok (สแกน QR หรือวาง URL)</h3>
    <p class="small muted">กดปุ่มด้านล่างเพื่อเปิดหน้า authorize (QR) — ถ้าไม่มี backend เพื่อแลก token ให้ใช้วิธีวาง token/JSON ด้วยตนเอง</p>
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <button class="btn" id="open-auth">เปิดหน้า authorize</button>
      <button class="btn" id="paste-token">วาง token JSON</button>
    </div>
    <div id="login-area"></div>
  </div>`)
  document.getElementById('view-area').appendChild(root)
  document.getElementById('open-auth').onclick = ()=>{ const u = buildAuthUrl(); window.open(u,'_blank'); alert('เปิดหน้า authorize — หลังจาก login ให้คัดลอก URL ที่ redirect แล้ววางในฟีเจอร์ \"วาง token JSON\"') }
  document.getElementById('paste-token').onclick = ()=>{ showPasteToken() }
}

function buildAuthUrl(){ const c=state.config; const params = new URLSearchParams({client_key:c.CLIENT_KEY,response_type:'code',scope:c.OAUTH_SCOPES,redirect_uri:c.REDIRECT_URI,state:'state123'}); return c.AUTHORIZE_BASE.split('?')[0] + '?' + params.toString() }
function showPasteToken(){ const root = document.getElementById('login-area'); root.innerHTML = `<div style="margin-top:8px"><textarea id='tokenjson' style='height:160px'></textarea><div style='margin-top:8px'><button class='btn' onclick='submitPastedToken()'>บันทึกเป็นบัญชี</button></div></div>` }
function submitPastedToken(){ try{ const raw = document.getElementById('tokenjson').value.trim(); if(!raw) return alert('ว่าง'); const obj = JSON.parse(raw); const id = uid(); const label = (obj.data&&obj.data.open_id) || obj.open_id || obj.data&&obj.data.username || 'tiktok_user_'+id; const acc = {id:id,label:label,created_at:(new Date()).toISOString(),tokens:obj}; state.accounts.push(acc); saveState(); alert('บันทึกบัญชี: '+label); nav('manage') } catch(e){ alert('JSON ผิด: '+e.message) } }

function renderComposer(){
  const root = el(`<div class='card'>
    <h3>สร้างโพสต์ (จำลอง - เก็บลงคิว)</h3>
    <div class='row'>
      <div class='col-2'>
        <label>ไฟล์ (เส้นทางบนเครื่อง)</label>
        <input id='file-input' placeholder='วาง path หรือเลือกโดย browser (local file not uploaded)' />
        <label>คำบรรยาย</label>
        <textarea id='caption' rows='4'></textarea>
        <label>เลือกบัญชี (Ctrl/Shift เลือกหลายรายการ)</label>
        <div id='acc-select' class='tree' style='border:1px solid rgba(255,255,255,0.02);padding:6px'></div>
        <div style='margin-top:8px'><button class='btn' onclick='postNow()'>โพสต์ทันที (เข้า queue)</button></div>
      </div>
      <div style='flex:1;padding-left:12px'>
        <h4>คิวโพสต์</h4>
        <div id='post-queue'></div>
      </div>
    </div>
  </div>`)
  document.getElementById('view-area').appendChild(root)
  const sel = document.getElementById('acc-select'); sel.innerHTML=''
  state.accounts.forEach(a=>{ const cb = document.createElement('div'); cb.innerHTML = `<label><input type='checkbox' value='${a.id}' /> ${a.label}</label>`; sel.appendChild(cb) })
  renderQueue()
}
function postNow(){ const file=document.getElementById('file-input').value.trim(); if(!file) return alert('เลือกไฟล์'); const caption=document.getElementById('caption').value.trim(); const checkboxes = Array.from(document.querySelectorAll('#acc-select input[type=checkbox]:checked')).map(n=>n.value);
  if(checkboxes.length===0) return alert('เลือกบัญชีอย่างน้อย 1 บัญชี');
  checkboxes.forEach(id=>{ const post={id:uid(),account_id:id,filepath:file,caption:caption,created_at:(new Date()).toISOString(),status:'queued'}; state.posts.push(post); })
  saveState(); renderQueue(); alert('ส่งเข้า queue เรียบร้อย') }
function renderQueue(){ const elq=document.getElementById('post-queue'); if(!elq) return; elq.innerHTML=''
  state.posts.filter(p=>p.status==='queued' || p.status==='posting').slice().reverse().forEach(p=>{ const acc = state.accounts.find(a=>a.id===p.account_id) || {label:p.account_id}; const d=document.createElement('div'); d.style.padding='8px'; d.innerHTML = `<div><strong>${acc.label}</strong> — ${p.caption||'(no caption)'} <div class='small muted'>${formatDate(p.created_at)} • ${p.status}</div></div>`; elq.appendChild(d) }) }

function renderLive(){ const root=el(`<div class='card'><h3>Live Manager</h3><p class='small muted'>ฟังก์ชัน live จะบันทึก RTMP ในบัญชี แต่ไม่สามารถเรียก ffmpeg จากเว็บได้ — ด้านล่างมีคำสั่งตัวอย่าง</p><div id='live-area'></div></div>`)
  document.getElementById('view-area').appendChild(root)
  const area=document.getElementById('live-area'); area.innerHTML=''
  state.accounts.forEach(a=>{
    const wrap = document.createElement('div'); wrap.className='card'; wrap.style.marginBottom='8px'; wrap.innerHTML = `<div style='display:flex;justify-content:space-between'><div><strong>${a.label}</strong><div class='small muted'>${a.created_at?formatDate(a.created_at):''}</div></div></div>
      <div style='margin-top:8px'><label>RTMP URL</label><input data-acc='${a.id}' class='rtmp-url' value='${(a.tokens&&a.tokens._rtmp_url)||''}' /><label>RTMP Key</label><input data-acc='${a.id}' class='rtmp-key' value='${(a.tokens&&a.tokens._rtmp_key)||''}' /><div style='margin-top:8px'><button class='btn' onclick='saveRtmp(${JSON.stringify(a.id)})'>บันทึก RTMP</button> <button class='btn' onclick='showFfmpegExample(${JSON.stringify(a.id)})'>ดูคำสั่ง ffmpeg</button></div></div>`
    area.appendChild(wrap)
  })
}
function saveRtmp(id){ const url = document.querySelector(`.rtmp-url[data-acc='${id}']`).value.trim(); const key = document.querySelector(`.rtmp-key[data-acc='${id}']`).value.trim(); const acc = state.accounts.find(a=>a.id===id); if(!acc) return; acc.tokens = acc.tokens || {}; acc.tokens._rtmp_url = url; acc.tokens._rtmp_key = key; saveState(); alert('บันทึก RTMP เรียบร้อย') }
function showFfmpegExample(id){ const acc = state.accounts.find(a=>a.id===id); if(!acc) return; const url = acc.tokens && acc.tokens._rtmp_url; const key = acc.tokens && acc.tokens._rtmp_key; if(!url||!key) return alert('ยังไม่บันทึก RTMP URL/Key')
  const target = url.replace(/\/+$/,'') + '/' + key; const cmd = `ffmpeg -re -stream_loop -1 -i input.mp4 -c:v libx264 -preset veryfast -b:v 2500k -c:a aac -ar 44100 -b:a 128k -f flv ${target}`;
  prompt('คำสั่งตัวอย่าง ffmpeg (คัดลอก):', cmd)
}

function renderHistory(){ const root = el(`<div class='card'><h3>ประวัติการโพสต์</h3><div id='hist-list'></div></div>`); document.getElementById('view-area').appendChild(root); const list = document.getElementById('hist-list'); list.innerHTML=''
  state.posts.slice().reverse().forEach(p=>{ const acc = state.accounts.find(a=>a.id===p.account_id) || {label:p.account_id}; const d = document.createElement('div'); d.style.padding='8px'; d.innerHTML = `<div><strong>${acc.label}</strong> — ${p.caption||'(no caption)'} <div class='small muted'>${formatDate(p.created_at)} • ${p.status}</div></div>`; list.appendChild(d) }) }

function renderManage(){ const root = el(`<div class='card'><h3>จัดการบัญชี</h3><div id='manage-list'></div><div style='margin-top:8px'><button class='btn' onclick='showAddAccount()'>เพิ่มบัญชีด้วย JSON</button></div></div>`); document.getElementById('view-area').appendChild(root); const ml=document.getElementById('manage-list'); ml.innerHTML=''
  state.accounts.forEach((a,idx)=>{ const d=document.createElement('div'); d.style.padding='8px'; d.style.borderBottom='1px solid rgba(255,255,255,0.02)'; d.innerHTML = `<div style='display:flex;justify-content:space-between'><div><strong>${a.label}</strong><div class='small muted'>${formatDate(a.created_at)}</div></div><div class='actions'><a class='link' onclick='copyTokens(${idx})'>คัดลอก tokens</a> <a class='link' onclick='deleteAccount(${idx})'>ลบ</a></div></div>`; ml.appendChild(d) }) }
function showAddAccount(){ const area = document.getElementById('manage-list'); const d=document.createElement('div'); d.innerHTML = `<div style='margin-top:8px'><textarea id='addaccjson' style='height:160px'></textarea><div style='margin-top:8px'><button class='btn' onclick='addAccountFromJson()'>เพิ่มจาก JSON</button></div></div>`; area.prepend(d) }
function addAccountFromJson(){ try{ const raw = document.getElementById('addaccjson').value.trim(); if(!raw) return alert('ว่าง'); const obj = JSON.parse(raw); const id=uid(); const label = (obj.data&&obj.data.open_id) || obj.open_id || obj.data&&obj.data.username || 'tiktok_user_'+id; const acc={id:id,label:label,created_at:(new Date()).toISOString(),tokens:obj}; state.accounts.push(acc); saveState(); alert('เพิ่มบัญชี: '+label); nav('manage') }catch(e){alert('JSON ผิด: '+e.message)} }
function copyTokens(idx){ const a=state.accounts[idx]; prompt('tokens JSON (คัดลอกได้)', JSON.stringify(a.tokens||{})) }
function deleteAccount(idx){ if(!confirm('ลบบัญชีนี้?')) return; state.accounts.splice(idx,1); saveState(); nav('manage') }

function renderSettings(){ /* intentionally kept but not exposed in UI */ }
function saveSettings(){ /* intentionally disabled */ }

// --- Product/cart helpers ---
function openLink(url){ window.open(url,'_blank') }
function addProductToCart(pid){ const sel = prompt('กรุณากรอก ID บัญชีที่จะเพิ่มสินค้า (หรือเลือกจากหน้าจัดการบัญชี)') 
  if(!sel) return; const accId = sel.trim(); const p = state.products.find(x=>x.id===pid) || {}; state.carts[accId] = state.carts[accId] || []; state.carts[accId].push({id:p.id,name:p.name,price:p.price}); saveState(); alert('เพิ่มสินค้าในตะกร้าให้บัญชี '+accId) }

// --- Initial render ---
nav('dashboard')

// Expose some helpers for console use
window.ttm = { state, saveState, loadState, nav }
</script>
</body>
</html>
